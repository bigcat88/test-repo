# .github/workflows/triage-reminder.yml
name: Issue triage reminders

on:
  schedule:
    - cron: '0 8 * * *'    # daily at 08:00 UTC
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  remind:
    runs-on: ubuntu-latest

    steps:
      # ğŸ›ï¸ Check out the code so we can read your config
      - name: Check out repo
        uses: actions/checkout@v3

      # ğŸ“– Load the "triage" block from your YAML config
      - name: Read triage config
        id: cfg
        uses: jbutcher5/read-yaml@1.6
        with:
          file: .github/issue-bot-config.yml
          key-path: '["triage"]'

      # ğŸ” Find open issues updated before â€œsinceâ€ (no longer restricting to unlabeled)
      - name: Find stale issues
        id: search
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const cfg = JSON.parse(process.env.CFG || '{}');
            const since = new Date(
              Date.now() - cfg.first_ping_after_days * 24*3600*1000
            ).toISOString();

            // NOTE: removed "no:label" so we catch reminder-1, reminder-2, etc.
            const q = [
              `repo:${context.repo.owner}/${context.repo.repo}`,
              `is:issue is:open`,
              `updated:<${since}`
            ].join(' ');

            const res = await github.rest.search.issuesAndPullRequests({
              q, per_page: 100
            });

            core.setOutput("issues", JSON.stringify(
              res.data.items.map(i => i.number)
            ));

        env:
          CFG: ${{ steps.cfg.outputs.data }}

      # ğŸ“¨ Ping & rotate reminder-N
      - name: Ping & rotate labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Safe parse
            const issues = JSON.parse(process.env.ISSUES || '[]');
            const cfg    = JSON.parse(process.env.CFG    || '{}');

            for (const num of issues) {
              const { data: issue } = await github.rest.issues.get({
                ...context.repo,
                issue_number: num
              });

              // âŒ Skip if any label is NOT a "reminder-N"
              const labels = issue.labels.map(l => l.name);
              if (labels.some(n => !/^reminder-\d+$/.test(n))) continue;

              // â±ï¸ Enforce repeat_every_days
              const cutoff = new Date(
                Date.now() - cfg.repeat_every_days * 24*3600*1000
              );
              if (new Date(issue.updated_at) > cutoff) continue;

              // ğŸ”¢ Compute next round
              const remLabel = labels.find(n => /^reminder-\d+$/.test(n));
              const current  = remLabel ? parseInt(remLabel.split('-')[1],10) : 0;
              const next     = current + 1;

              // ğŸš¨ Escalate mentions once we hit the threshold
              const mention = next >= cfg.escalation_ping
                ? '\n\n' + (cfg.escalation_mentions || []).join(' ')
                : '';

              // ğŸ’¬ Post the reminder
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: num,
                body: `ğŸ”” Friendly reminder â€“ please triage this issue.${mention}`
              });

              // ğŸ·ï¸ Rotate the label
              if (remLabel) {
                await github.rest.issues.removeLabel({
                  ...context.repo,
                  issue_number: num,
                  name: remLabel
                }).catch(()=>{/* ignore if already gone */});
              }
              await github.rest.issues.addLabels({
                ...context.repo,
                issue_number: num,
                labels: [`reminder-${next}`]
              });
            }
        env:
          ISSUES: ${{ steps.search.outputs.issues }}
          CFG:    ${{ steps.cfg.outputs.data }}
